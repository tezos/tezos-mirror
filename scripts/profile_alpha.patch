From b9179f897a3f03ce43cf67eb7aefd8f554c233f5 Mon Sep 17 00:00:00 2001
From: Pierrick Couderc <pierrick.couderc@nomadic-labs.com>
Date: Wed, 22 Oct 2025 15:05:41 +0200
Subject: [PATCH 1/1] Proto_alpha: profiler patch

---
 src/proto_alpha/lib_protocol/apply.ml         | 17 ++--
 src/proto_alpha/lib_protocol/baking.ml        |  4 +-
 .../lib_protocol/delegate_cycles.ml           | 78 +++++++++++++++----
 src/proto_alpha/lib_protocol/dune             |  2 +
 src/proto_alpha/lib_protocol/init_storage.ml  | 24 +++++-
 src/proto_alpha/lib_protocol/raw_context.ml   |  4 +-
 src/proto_alpha/lib_protocol/script_cache.ml  | 19 ++---
 .../lib_protocol/script_interpreter.ml        | 15 ++++
 .../lib_protocol/script_ir_translator.ml      | 26 ++++---
 9 files changed, 142 insertions(+), 47 deletions(-)

diff --git a/src/proto_alpha/lib_protocol/apply.ml b/src/proto_alpha/lib_protocol/apply.ml
index cdbeea9ee4..b4df332c44 100644
--- a/src/proto_alpha/lib_protocol/apply.ml
+++ b/src/proto_alpha/lib_protocol/apply.ml
@@ -2508,7 +2508,11 @@ let apply_manager_operations ctxt ~payload_producer chain_id ~mempool_mode
     ~source ~operation contents_list =
   let open Lwt_result_syntax in
   let ctxt = if mempool_mode then Gas.reset_block_gas ctxt else ctxt in
-  let* ctxt, fees_updated_contents_list = take_fees ctxt contents_list in
+  let* ctxt, fees_updated_contents_list =
+    (take_fees
+       ctxt
+       contents_list [@profiler.record_s {verbosity = Notice} "take_fees"])
+  in
   let gas_cost_for_sig_check =
     let algo =
       Michelson_v1_gas.Cost_of.Interpreter.algo_of_public_key_hash source
@@ -2787,11 +2791,12 @@ let may_start_new_cycle ctxt =
   match Level.dawn_of_a_new_cycle ctxt with
   | None -> return (ctxt, [], [])
   | Some last_cycle ->
-      let* ctxt, balance_updates, deactivated =
-        Delegate.cycle_end ctxt last_cycle
-      in
-      let+ ctxt = Bootstrap.cycle_end ctxt last_cycle in
-      (ctxt, balance_updates, deactivated)
+      (let* ctxt, balance_updates, deactivated =
+         Delegate.cycle_end ctxt last_cycle
+       in
+       let+ ctxt = Bootstrap.cycle_end ctxt last_cycle in
+       (ctxt, balance_updates, deactivated))
+      [@profiler.record_s {verbosity = Notice} "delegate end cycle"]

 let apply_liquidity_baking_subsidy ctxt ~per_block_vote =
   let open Lwt_result_syntax in
diff --git a/src/proto_alpha/lib_protocol/baking.ml b/src/proto_alpha/lib_protocol/baking.ml
index 7cf362b259..a45d1eda4a 100644
--- a/src/proto_alpha/lib_protocol/baking.ml
+++ b/src/proto_alpha/lib_protocol/baking.ml
@@ -114,7 +114,7 @@ type ordered_slots = {
 (* Slots returned by this function are assumed by consumers to be in increasing
    order, hence the use of [Slot.Range.rev_fold_es]. *)
 let attesting_rights (ctxt : t) ~attested_level =
-  let consensus_committee_size = Constants.consensus_committee_size ctxt in
+  (let consensus_committee_size = Constants.consensus_committee_size ctxt in
   let all_bakers_attest_enabled =
     Attesting_power.check_all_bakers_attest_at_level ctxt ~attested_level
   in
@@ -214,7 +214,7 @@ let attesting_rights (ctxt : t) ~attested_level =
         map
     else map
   in
-  return (ctxt, map)
+  return (ctxt, map)) [@profiler.record_s {verbosity = Notice} "attesting_rights"]

 let incr_slot att_rights =
   let one = Attesting_power.make ~slots:1 ~stake:0L in
diff --git a/src/proto_alpha/lib_protocol/delegate_cycles.ml b/src/proto_alpha/lib_protocol/delegate_cycles.ml
index a666a47b9b..6c87495e8a 100644
--- a/src/proto_alpha/lib_protocol/delegate_cycles.ml
+++ b/src/proto_alpha/lib_protocol/delegate_cycles.ml
@@ -225,42 +225,92 @@ let distribute_attesting_rewards ctxt last_cycle unrevealed_nonces =
 let cycle_end ctxt last_cycle =
   let open Lwt_result_syntax in
   (* attributing attesting rewards   *)
-  let* ctxt, unrevealed_nonces = Seed_storage.cycle_end ctxt last_cycle in
+  let* ctxt, unrevealed_nonces =
+    (Seed_storage.cycle_end
+       ctxt
+       last_cycle
+     [@profiler.record_s {verbosity = Notice} "seed storage cycle end"])
+  in
   let* ctxt, attesting_balance_updates =
-    distribute_attesting_rewards ctxt last_cycle unrevealed_nonces
+    (distribute_attesting_rewards
+       ctxt
+       last_cycle
+       unrevealed_nonces
+     [@profiler.record_s {verbosity = Notice} "distribute attesting rewards"])
   in
   (* Applying slashing related to expiring denunciations *)
   let* ctxt, slashing_balance_updates =
-    Delegate_slashed_deposits_storage.apply_and_clear_denunciations ctxt
+    (Delegate_slashed_deposits_storage.apply_and_clear_denunciations
+       ctxt
+     [@profiler.record_s {verbosity = Notice} "apply and clear denunciations"])
   in
   let new_cycle = Cycle_repr.add last_cycle 1 in
-  let*! ctxt = Already_denounced_storage.clear_outdated_cycle ctxt ~new_cycle in
+  let*! ctxt =
+    (Already_denounced_storage.clear_outdated_cycle
+       ctxt
+       ~new_cycle
+     [@profiler.record_s {verbosity = Notice} "clear outdated cycle"])
+  in
   let*! ctxt =
     Dal_already_denounced_storage.clear_outdated_cycle ctxt ~new_cycle
   in
   (* Deactivating delegates which didn't participate to consensus for too long *)
-  let* ctxt, deactivated_delegates = update_activity ctxt last_cycle in
+  let* ctxt, deactivated_delegates =
+    (update_activity
+       ctxt
+       last_cycle [@profiler.record_s {verbosity = Notice} "update activity"])
+  in
   (* Computing future staking rights *)
   let* ctxt =
-    Delegate_sampler.select_new_distribution_at_cycle_end ctxt ~new_cycle
+    (Delegate_sampler.select_new_distribution_at_cycle_end
+       ctxt
+       ~new_cycle
+     [@profiler.record_s
+       {verbosity = Notice} "select new distribution at cycle end"])
   in
   (* Activating consensus key for the cycle to come *)
-  let*! ctxt = Delegate_consensus_key.activate ctxt ~new_cycle in
+  let*! ctxt =
+    (Delegate_consensus_key.activate
+       ctxt
+       ~new_cycle
+     [@profiler.record_s {verbosity = Notice} "activate consensus key"])
+  in
   (* trying to unforbid delegates for the cycle to come. *)
   let* ctxt =
-    Forbidden_delegates_storage.update_at_cycle_end_after_slashing
-      ctxt
-      ~new_cycle
+    (Forbidden_delegates_storage.update_at_cycle_end_after_slashing
+       ctxt
+       ~new_cycle
+     [@profiler.record_s
+       {verbosity = Notice} "update at cycle end after slashing"])
   in
   (* clear deprecated cycles data.  *)
-  let* ctxt = Stake_storage.clear_at_cycle_end ctxt ~new_cycle in
-  let* ctxt = Delegate_sampler.clear_outdated_sampling_data ctxt ~new_cycle in
+  let* ctxt =
+    (Stake_storage.clear_at_cycle_end
+       ctxt
+       ~new_cycle
+     [@profiler.record_s {verbosity = Notice} "clear stake storage"])
+  in
+  let* ctxt =
+    (Delegate_sampler.clear_outdated_sampling_data
+       ctxt
+       ~new_cycle
+     [@profiler.record_s {verbosity = Notice} "clear outdated sampling data"])
+  in
   (* activate delegate parameters for the cycle to come.  *)
-  let*! ctxt = Delegate_staking_parameters.activate ctxt ~new_cycle in
+  let*! ctxt =
+    (Delegate_staking_parameters.activate
+       ctxt
+       ~new_cycle
+     [@profiler.record_s {verbosity = Notice} "activate staking parameters"])
+  in
   (* updating AI coefficient. It should remain after all balance changes of the
      cycle-end operations *)
   let* ctxt =
-    Adaptive_issuance_storage.update_stored_rewards_at_cycle_end ctxt ~new_cycle
+    (Adaptive_issuance_storage.update_stored_rewards_at_cycle_end
+       ctxt
+       ~new_cycle
+     [@profiler.record_s
+       {verbosity = Notice} "update stored rewards at cycle end"])
   in
   let balance_updates = slashing_balance_updates @ attesting_balance_updates in
   return (ctxt, balance_updates, deactivated_delegates)
diff --git a/src/proto_alpha/lib_protocol/dune b/src/proto_alpha/lib_protocol/dune
index f1a9e3bf62..bce1980044 100644
--- a/src/proto_alpha/lib_protocol/dune
+++ b/src/proto_alpha/lib_protocol/dune
@@ -23,6 +23,8 @@
  (instrumentation (backend bisect_ppx))
  (libraries
   tezos-protocol-alpha.protocol.environment)
+ (preprocess (pps octez-libs.ppx_profiler))
+ (preprocessor_deps (env_var TEZOS_PPX_PROFILER))
  (library_flags (:standard -linkall))
  (flags
   (:standard)
diff --git a/src/proto_alpha/lib_protocol/init_storage.ml b/src/proto_alpha/lib_protocol/init_storage.ml
index 84795cc0c52..df298fe7dcc 100644
--- a/src/proto_alpha/lib_protocol/init_storage.ml
+++ b/src/proto_alpha/lib_protocol/init_storage.ml
@@ -252,10 +252,20 @@ let prepare_first_block chain_id ctxt ~typecheck_smart_contract
         return (ctxt, commitments_balance_updates @ bootstrap_balance_updates)
         (* Start of Alpha stitching. Comment used for automatic snapshot *)
     | Alpha ->
-        let* ctxt = Storage.Protocol_activation_level.update ctxt level in
+        let* ctxt =
+          (Storage.Protocol_activation_level.update
+             ctxt
+             level
+           [@profiler.record_s
+             {verbosity = Notice} "Protocol_activation_level.update"])
+        in
         (* Migration of refutation games needs to be kept for each protocol. *)
         let* ctxt =
-          Sc_rollup_refutation_storage.migrate_clean_refutation_games ctxt
+          (Sc_rollup_refutation_storage.migrate_clean_refutation_games
+             ctxt
+           [@profiler.record_s
+             {verbosity = Notice}
+               "Sc_rollup_refutation_storage.migrate_clean_refutation_games"])
         in
         return (ctxt, [])
         (* End of Alpha stitching. Comment used for automatic snapshot *)
@@ -263,11 +273,19 @@ let prepare_first_block chain_id ctxt ~typecheck_smart_contract
     | T024 ->
         let* ctxt =
           let*! ctxt = Storage.Tenderbake.First_level_of_protocol.remove ctxt in
-          Storage.Protocol_activation_level.init ctxt level
+          (Storage.Protocol_activation_level.init
+             ctxt
+             level
+           [@profiler.record_s
+             {verbosity = Notice} "Protocol_Activation_level.init"])
         in
         (* Migration of refutation games needs to be kept for each protocol. *)
         let* ctxt =
-          Sc_rollup_refutation_storage.migrate_clean_refutation_games ctxt
+          (Sc_rollup_refutation_storage.migrate_clean_refutation_games
+             ctxt
+           [@profiler.record_s
+             {verbosity = Notice}
+               "Sc_rollup_refutation_storage.migrate_clean_refutation_games"])
         in
         return (ctxt, [])
     (* End of alpha predecessor stitching. Comment used for automatic snapshot *)
diff --git a/src/proto_alpha/lib_protocol/raw_context.ml b/src/proto_alpha/lib_protocol/raw_context.ml
index c501d7fc16..00e5338465 100644
--- a/src/proto_alpha/lib_protocol/raw_context.ml
+++ b/src/proto_alpha/lib_protocol/raw_context.ml
@@ -1628,12 +1628,12 @@ let prepare_first_block ~level ~timestamp chain_id ctxt =
     (* End of alpha predecessor stitching. Comment used for automatic snapshot *)
   in
   let+ ctxt =
-    prepare
+    (prepare
       ctxt
       ~level
       ~predecessor_timestamp:timestamp
       ~timestamp
-      ~all_bakers_attest_first_level:None
+      ~all_bakers_attest_first_level:None [@profiler.record_s {verbosity = Notice} "Prepare"])
   in
   (previous_proto, previous_proto_constants, ctxt)

diff --git a/src/proto_alpha/lib_protocol/script_cache.ml b/src/proto_alpha/lib_protocol/script_cache.ml
index 35cc6b5178..5c679ad606 100644
--- a/src/proto_alpha/lib_protocol/script_cache.ml
+++ b/src/proto_alpha/lib_protocol/script_cache.ml
@@ -98,15 +98,16 @@ let find ctxt addr =
   | Some (unparsed_script, ex_script) ->
       return (ctxt, identifier, Some (unparsed_script, ex_script))
   | None -> (
-      let* ctxt, result = load_and_elaborate ctxt addr in
-      match result with
-      | None -> return (ctxt, identifier, None)
-      | Some (unparsed_script, script_ir, size) ->
-          let cached_value = (unparsed_script, script_ir) in
-          let*? ctxt =
-            Cache.update ctxt identifier (Some (cached_value, size))
-          in
-          return (ctxt, identifier, Some (unparsed_script, script_ir)))
+      (let* ctxt, result = load_and_elaborate ctxt addr in
+       match result with
+       | None -> return (ctxt, identifier, None)
+       | Some (unparsed_script, script_ir, size) ->
+           let cached_value = (unparsed_script, script_ir) in
+           let*? ctxt =
+             Cache.update ctxt identifier (Some (cached_value, size))
+           in
+           return (ctxt, identifier, Some (unparsed_script, script_ir)))
+      [@profiler.record_s {verbosity = Notice} "cache_miss"])

 let update ctxt identifier updated_script approx_size =
   Cache.update ctxt identifier (Some (updated_script, approx_size))
diff --git a/src/proto_alpha/lib_protocol/script_interpreter.ml b/src/proto_alpha/lib_protocol/script_interpreter.ml
index 182af698fa..23620cd13c 100644
--- a/src/proto_alpha/lib_protocol/script_interpreter.ml
+++ b/src/proto_alpha/lib_protocol/script_interpreter.ml
@@ -1878,10 +1878,12 @@ let execute_any_arg logger ctxt mode step_constants ~entrypoint ~internal
         trace
           (Runtime_contract_error step_constants.self)
           (interp logger (ctxt, step_constants) code (arg, old_storage))
+        [@profiler.record_s {verbosity = Notice} "interprete"]
     | Native {kind} ->
         trace
           (Runtime_contract_error step_constants.self)
           (Script_native.execute (ctxt, step_constants) kind arg old_storage)
+        [@profiler.record_s {verbosity = Notice} "interprete_native"]
   in
   let* storage, lazy_storage_diff, ctxt =
     Script_ir_translator.extract_lazy_storage_diff
@@ -1959,6 +1961,19 @@ let execute_any_arg logger ctxt mode step_constants ~entrypoint ~internal
       },
       ctxt )

+let execute_any_arg logger ctxt mode step_constants ~entrypoint ~internal
+    unparsed_script cached_script arg =
+  execute_any_arg
+    logger
+    ctxt
+    mode
+    step_constants
+    ~entrypoint
+    ~internal
+    unparsed_script
+    cached_script
+    arg [@profiler.record_s {verbosity = Notice} "execute"]
+
 let execute_with_typed_parameter ?logger ctxt ~cached_script mode step_constants
     ~script ~entrypoint ~parameter_ty ~location ~parameter ~internal =
   execute_any_arg
diff --git a/src/proto_alpha/lib_protocol/script_ir_translator.ml b/src/proto_alpha/lib_protocol/script_ir_translator.ml
index 05e30ca6ee..b618445e78 100644
--- a/src/proto_alpha/lib_protocol/script_ir_translator.ml
+++ b/src/proto_alpha/lib_protocol/script_ir_translator.ml
@@ -5269,21 +5269,27 @@ let parse_script :
            storage ) =
       match script with
       | Script {code; storage} ->
-          let* ex_code = parse_code ~unparse_code_rec ~elab_conf ctxt ~code in
+          let* ex_code =
+            (parse_code
+               ~unparse_code_rec
+               ~elab_conf
+               ctxt
+               ~code [@profiler.record_s {verbosity = Notice} "parse_code"])
+          in
           return (ex_code, storage)
       | Native {kind; storage} ->
           let* ex_code = get_typed_native_code ctxt ~kind in
           return (ex_code, storage)
     in
     let+ storage, ctxt =
-      parse_storage
-        ~unparse_code_rec
-        ~elab_conf
-        ctxt
-        ~allow_forged_tickets:allow_forged_tickets_in_storage
-        ~allow_forged_lazy_storage_id:allow_forged_lazy_storage_id_in_storage
-        storage_type
-        ~storage
+      (parse_storage
+         ~unparse_code_rec
+         ~elab_conf
+         ctxt
+         ~allow_forged_tickets:allow_forged_tickets_in_storage
+         ~allow_forged_lazy_storage_id:allow_forged_lazy_storage_id_in_storage
+         storage_type
+         ~storage [@profiler.record_s {verbosity = Notice} "parse_storage"])
     in
     ( Ex_script
         (Script
@@ -5990,7 +5996,7 @@ let parse_data ~elab_conf ctxt ~allow_forged_tickets
     ~stack_depth:0
     ctxt
     ty
-    t
+    t [@profiler.record_s {verbosity = Notice} "parse_data"]

 let parse_view ~elab_conf ctxt ty view =
   parse_view ~unparse_code_rec ~elab_conf ctxt ty view
--
2.51.1.dirty
