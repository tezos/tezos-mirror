# Basic, specialised, minimal, orthogonal templates

# Some settings we want by default on all jobs that cannot be set
# through the key `default` in `.gitlab-ci.yml`.
.default_settings_template:
  # `dependencies` are empty be default. Each individual job or
  # template requiring artifacts from preceeding jobs should declare
  # their dependencies locally.
  dependencies: []
  tags: ["gcp"]

# Default runner tags for jobs in the build stage
.tags_template__build:
  tags: ["gcp"]

# Default runner tags for arm64 jobs in the build stage
.tags_template__build_arm64:
  tags: ["gcp_arm64"]

# Block the propagation of the GCP tag for standard jobs
.tags_template__no_gcp:
  tags: []

# Block the propagation of the GCP tag for arm64 jobs
.tags_template__no_gcp_arm64:
  tags: ["arm64"]

# Run on after job 'trigger'. Run immediately if there is no 'trigger' job (i.e. non-before_merging pipelines).
.needs__trigger:
  needs:
    - job: trigger
      optional: true

# Only if octez source code has changed
.rules__octez_changes:
  rules:
    - changes:
        paths:
          - src/**/*
          - etherlink/**/*
          - tezt/**/*
          - .gitlab/**/*
          - .gitlab-ci.yml
          - michelson_test_scripts/**/*
          - tzt_reference_test_suite/**/*
      when: on_success

# Only if octez source code has changed or Marge Bot is the trigger
.rules__octez_changes_or_margebot:
  rules:
    - changes:
        paths:
          - src/**/*
          - etherlink/**/*
          - tezt/**/*
          - .gitlab/**/*
          - .gitlab-ci.yml
          - michelson_test_scripts/**/*
          - tzt_reference_test_suite/**/*
      when: on_success
    - if: '$GITLAB_USER_LOGIN == "nomadic-margebot"'
      when: on_success

# Only if documentation has changed
.rules__octez_docs_changes:
  rules:
    - changes:
        paths:
          - scripts/**/*/
          - script-inputs/**/*/
          - src/**/*
          - tezt/**/*
          - vendors/**/*
          - dune
          - dune-project
          - dune-workspace
          - docs/**/*
          - .gitlab/**/*
          - .gitlab-ci.yml
      when: on_success

# Only if the dependencies of the Octez Docker changed or if we're on
# master.
.rules__octez_docker_changes_or_master:
  rules:
      - if: '$CI_COMMIT_BRANCH == "master"'
        when: on_success
      - changes:
          - scripts/**/*
          - script-inputs/**/*
          - src/**/*
          - tezt/**/*
          - vendors/**/*
          - dune
          - dune-project
          - dune-workspace
          - opam
          - Makefile
          - kernels.mk
          - build.Dockerfile
          - Dockerfile
          - .gitlab/**/*
          - .gitlab-ci.yml
        when: on_success

# Add variables for bisect_ppx instrumentation
.oc.template__coverage:
  variables:
    COVERAGE_OPTIONS: "--instrument-with bisect_ppx"
    BISECT_FILE: "$CI_PROJECT_DIR/_coverage_output/"
    SLACK_COVERAGE_CHANNEL: "C02PHBE7W73"

.oc.build_template:
  extends:
    - .default_settings_template
    - .image_template__runtime_build_dependencies
    - .oc.template__coverage
  stage: build
  before_script:
    - ./scripts/ci/take_ownership.sh
    - . ./scripts/version.sh
    - eval $(opam env)

.oc.kernels_template:
  extends:
    - .default_settings_template
    - .image_template__rust_toolchain
    - .needs__trigger
    - .rules__octez_changes
  variables:
    CC: clang
    CARGO_HOME: $CI_PROJECT_DIR/cargo
    NATIVE_TARGET: x86_64-unknown-linux-musl

.docker_auth_template:
  extends:
    - .default_settings_template
  variables:
    # Version of the docker to use, docker daemon ad client must
    # be in the same version.git
    DOCKER_VERSION: "24.0.6"
  before_script:
    - ./scripts/ci/docker_wait_for_daemon.sh
    - ./scripts/ci/docker_check_version.sh ${DOCKER_VERSION}
    - ./scripts/ci/docker_registry_auth.sh
  services:
    - docker:${DOCKER_VERSION}-dind

.oc.misc_checks:
  extends:
    - .default_settings_template
    - .image_template__runtime_build_test_dependencies
    - .needs__trigger
  stage: "test"
  before_script:
    - ./scripts/ci/take_ownership.sh
    - . ./scripts/version.sh
    - eval $(opam env)
    # Load the environment poetry previously created in the docker image.
    # Give access to the Python dependencies/executables
    - . $HOME/.venv/bin/activate
  rules:
    # The linting job runs over the set of [source_directories]
    # defined in [scripts/lint.sh] that must be included here:
    - changes:
        paths:
        - src/**/*
        - tezt/**/*
        - devtools/**/*
        - scripts/**/*
        - docs/**/*
        - contrib/**/*
        - etherlink/**/*
        - .gitlab-ci.yml
        - .gitlab/**/*
