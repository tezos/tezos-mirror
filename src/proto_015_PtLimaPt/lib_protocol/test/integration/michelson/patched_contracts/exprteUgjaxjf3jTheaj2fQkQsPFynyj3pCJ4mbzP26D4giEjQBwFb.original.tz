{ parameter %main unit ;
  storage
    (pair :storage
       (big_map :depositors address mutez)
       (pair (address %owner)
             (pair (mutez %min_deposit)
                   (pair (nat %withdraw_fee)
                         (pair (nat %collat_coeff)
                               (pair (mutez %deposited)
                                     (pair (mutez %borrowed) (pair (nat %depositors_size) (key_hash %delegate))))))))) ;
  code { DUP ;
         DIP { CDR @storage_slash_1 } ;
         CAR @__slash_2 ;
         PUSH @one_prec6 nat 1000000 ;
         LAMBDA
           (pair (pair mutez nat) nat)
           mutez
           { RENAME @_amount_coeff__one_prec6_slash_8 ;
             DUP ;
             CDR @one_prec6_slash_3 ;
             DIP { DUP } ;
             SWAP ;
             CAR ;
             CDR @coeff ;
             DIP 2 { DUP } ;
             DIG 2 ;
             CAR ;
             CAR @amount ;
             MUL ;
             EDIV ;
             IF_NONE
               { PUSH string "Division error in `apply_coeff`." ; FAILWITH }
               { CAR } ;
             DIP { DROP } } ;
         PAIR @apply_coeff ;
         SENDER @sender ;
         AMOUNT @amount ;
         BALANCE @contract_balance ;
         DIP 5 { DUP @storage } ;
         DIG 5 ;
         DUP @s ;
         { CDR ; CAR %owner } ;
         DIP 4 { DUP @sender } ;
         DIG 4 ;
         COMPARE ;
         NEQ ;
         PUSH mutez 1000000 ;
         DIP 4 { DUP @amount } ;
         DIG 4 ;
         COMPARE ;
         GT ;
         AND ;
         IF { DUP @s ;
              { CDR ; CDR ; CAR @min_deposit %min_deposit } ;
              DIP 3 { DUP @amount } ;
              DIG 3 ;
              COMPARE ;
              LT ;
              IF { PUSH string "Deposited amount is too small." ; FAILWITH } { UNIT } ;
              DROP ;
              DUP @s ;
              CAR %depositors ;
              DIP 4 { DUP @sender } ;
              DIG 4 ;
              GET ;
              IF_NONE
                { DUP @s ;
                  DUP ;
                  CAR %depositors ;
                  SWAP ;
                  CDR ;
                  DUP ;
                  CAR %owner ;
                  SWAP ;
                  CDR ;
                  DUP ;
                  CAR %min_deposit ;
                  SWAP ;
                  CDR ;
                  DUP ;
                  CAR %withdraw_fee ;
                  SWAP ;
                  CDR ;
                  DUP ;
                  CAR %collat_coeff ;
                  SWAP ;
                  CDR ;
                  DUP ;
                  CAR %deposited ;
                  SWAP ;
                  CDR ;
                  DUP ;
                  CAR %borrowed ;
                  SWAP ;
                  CDR ;
                  CDR %delegate ;
                  PUSH nat 1 ;
                  DIP 9 { DUP @s } ;
                  DIG 9 ;
                  { CDR ; CDR ; CDR ; CDR ; CDR ; CDR ; CDR ; CAR %depositors_size } ;
                  ADD ;
                  PAIR %depositors_size %delegate ;
                  SWAP ;
                  PAIR %borrowed ;
                  SWAP ;
                  PAIR %deposited ;
                  SWAP ;
                  PAIR %collat_coeff ;
                  SWAP ;
                  PAIR %withdraw_fee ;
                  SWAP ;
                  PAIR %min_deposit ;
                  SWAP ;
                  PAIR %owner ;
                  SWAP ;
                  PAIR %depositors ;
                  DIP 3 { DUP @amount } ;
                  DIG 3 ;
                  PAIR }
                { DIP { DUP @s } ;
                  SWAP ;
                  DIP 4 { DUP @amount } ;
                  DIG 4 ;
                  DIP 2 { DUP @b } ;
                  DIG 2 ;
                  DIP 3 { DROP } ;
                  ADD ;
                  PAIR } ;
              RENAME @_user_balance_s ;
              DUP ;
              CDR @s ;
              DUP @s ;
              CDR ;
              DIP { DUP @s } ;
              SWAP ;
              CAR %depositors ;
              DIP 3 { DUP } ;
              DIG 3 ;
              CAR @user_balance ;
              DIP 8 { DUP @sender } ;
              DIG 8 ;
              DIP { SOME } ;
              UPDATE ;
              PAIR @s %depositors ;
              DUP @s ;
              DUP ;
              CAR %depositors ;
              SWAP ;
              CDR ;
              DUP ;
              CAR %owner ;
              SWAP ;
              CDR ;
              DUP ;
              CAR %min_deposit ;
              SWAP ;
              CDR ;
              DUP ;
              CAR %withdraw_fee ;
              SWAP ;
              CDR ;
              DUP ;
              CAR %collat_coeff ;
              SWAP ;
              CDR ;
              CDR ;
              DIP 11 { DUP @amount } ;
              DIG 11 ;
              DIP 7 { DUP @s } ;
              DIG 7 ;
              DIP 8 { DROP 3 } ;
              { CDR ; CDR ; CDR ; CDR ; CDR ; CAR %deposited } ;
              ADD ;
              PAIR %deposited ;
              SWAP ;
              PAIR %collat_coeff ;
              SWAP ;
              PAIR %withdraw_fee ;
              SWAP ;
              PAIR %min_deposit ;
              SWAP ;
              PAIR %owner ;
              SWAP ;
              PAIR @s %depositors ;
              NIL operation ;
              PAIR }
            { DUP @s ;
              { CDR ; CAR %owner } ;
              DIP 4 { DUP @sender } ;
              DIG 4 ;
              COMPARE ;
              NEQ ;
              PUSH mutez 1000000 ;
              DIP 4 { DUP @amount } ;
              DIG 4 ;
              COMPARE ;
              LE ;
              AND ;
              IF { DUP @s ;
                   CAR %depositors ;
                   DIP 4 { DUP @sender } ;
                   DIG 4 ;
                   GET ;
                   IF_NONE { PUSH string "Only depositors can withdraw." ; FAILWITH } {} ;
                   RENAME @user_balance ;
                   DIP 2 { DUP @contract_balance } ;
                   DIG 2 ;
                   DIP { DUP @user_balance } ;
                   SWAP ;
                   COMPARE ;
                   GT ;
                   IF { PUSH string "Withdraw amount greater than current contract balance." ;
                        FAILWITH }
                      { UNIT } ;
                   DROP ;
                   DIP { DUP @s } ;
                   SWAP ;
                   DUP ;
                   CAR %depositors ;
                   SWAP ;
                   CDR ;
                   DUP ;
                   CAR %owner ;
                   SWAP ;
                   CDR ;
                   DUP ;
                   CAR %min_deposit ;
                   SWAP ;
                   CDR ;
                   DUP ;
                   CAR %withdraw_fee ;
                   SWAP ;
                   CDR ;
                   DUP ;
                   CAR %collat_coeff ;
                   SWAP ;
                   CDR ;
                   CDR ;
                   DIP 6 { DUP @user_balance } ;
                   DIG 6 ;
                   DIP 8 { DUP @s } ;
                   DIG 8 ;
                   { CDR ; CDR ; CDR ; CDR ; CDR ; CAR %deposited } ;
                   SUB ;
                   PAIR %deposited ;
                   SWAP ;
                   PAIR %collat_coeff ;
                   SWAP ;
                   PAIR %withdraw_fee ;
                   SWAP ;
                   PAIR %min_deposit ;
                   SWAP ;
                   PAIR %owner ;
                   SWAP ;
                   PAIR @s %depositors ;
                   DUP @s ;
                   CDR ;
                   DIP { DUP @s } ;
                   SWAP ;
                   CAR %depositors ;
                   NONE mutez ;
                   DIP 8 { DUP @sender } ;
                   DIG 8 ;
                   UPDATE ;
                   PAIR @s %depositors ;
                   DUP @s ;
                   DUP ;
                   CAR %depositors ;
                   SWAP ;
                   CDR ;
                   DUP ;
                   CAR %owner ;
                   SWAP ;
                   CDR ;
                   DUP ;
                   CAR %min_deposit ;
                   SWAP ;
                   CDR ;
                   DUP ;
                   CAR %withdraw_fee ;
                   SWAP ;
                   CDR ;
                   DUP ;
                   CAR %collat_coeff ;
                   SWAP ;
                   CDR ;
                   DUP ;
                   CAR %deposited ;
                   SWAP ;
                   CDR ;
                   DUP ;
                   CAR %borrowed ;
                   SWAP ;
                   CDR ;
                   CDR %delegate ;
                   PUSH nat 1 ;
                   DIP 9 { DUP @s } ;
                   DIG 9 ;
                   { CDR ; CDR ; CDR ; CDR ; CDR ; CDR ; CDR ; CAR %depositors_size } ;
                   SUB ;
                   DUP ;
                   ABS ;
                   SWAP ;
                   GE ;
                   IF {} { PUSH string "Depositors counting error." ; FAILWITH } ;
                   PAIR %depositors_size %delegate ;
                   SWAP ;
                   PAIR %borrowed ;
                   SWAP ;
                   PAIR %deposited ;
                   SWAP ;
                   PAIR %collat_coeff ;
                   SWAP ;
                   PAIR %withdraw_fee ;
                   SWAP ;
                   PAIR %min_deposit ;
                   SWAP ;
                   PAIR %owner ;
                   SWAP ;
                   PAIR @s %depositors ;
                   DIP 8 { DUP @apply_coeff } ;
                   DIG 8 ;
                   DIP { DUP @s } ;
                   SWAP ;
                   { CDR ; CDR ; CDR ; CAR %withdraw_fee } ;
                   DIP 5 { DUP @user_balance } ;
                   DIG 5 ;
                   PAIR ;
                   DIP { DUP ; CAR ; SWAP ; CDR } ;
                   PAIR ;
                   EXEC @fee_amount ;
                   DIP { DUP @s } ;
                   SWAP ;
                   NIL operation ;
                   DIP 10 { DUP @sender } ;
                   DIG 10 ;
                   CONTRACT unit ;
                   IF_NONE
                     { PUSH string "No entrypoint default with parameter type unit" ; FAILWITH }
                     {} ;
                   DIP 10 { DUP @amount } ;
                   DIG 10 ;
                   DIP 4 { DUP @fee_amount } ;
                   DIG 4 ;
                   DIP 9 { DUP @user_balance } ;
                   DIG 9 ;
                   SUB ;
                   ADD @withdraw_amount ;
                   UNIT ;
                   TRANSFER_TOKENS @op_withdraw ;
                   CONS ;
                   DIP 3 { DUP @s } ;
                   DIG 3 ;
                   { CDR ; CAR %owner } ;
                   CONTRACT unit ;
                   IF_NONE
                     { PUSH string "No entrypoint default with parameter type unit" ; FAILWITH }
                     {} ;
                   DIP 3 { DUP @fee_amount } ;
                   DIG 3 ;
                   DIP 4 { DROP 5 } ;
                   UNIT ;
                   TRANSFER_TOKENS @op_fee ;
                   CONS ;
                   PAIR }
                 { DUP @s ;
                   { CDR ; CAR %owner } ;
                   DIP 4 { DUP @sender } ;
                   DIG 4 ;
                   COMPARE ;
                   EQ ;
                   PUSH mutez 0 ;
                   DIP 4 { DUP @amount } ;
                   DIG 4 ;
                   COMPARE ;
                   EQ ;
                   AND ;
                   IF { PUSH @one_prec6 nat 1000000 ;
                        LAMBDA
                          (pair nat nat)
                          nat
                          { RENAME @coeff__one_prec6_slash_14 ;
                            DUP ;
                            CAR @coeff_slash_15 ;
                            DIP { DUP } ;
                            SWAP ;
                            CDR @one_prec6_slash_3 ;
                            SUB ;
                            DUP ;
                            ABS ;
                            SWAP ;
                            GE ;
                            IF {}
                               { PUSH string "Invalid coefficient value in `get_coeff_compl`." ; FAILWITH } ;
                            DIP { DROP } } ;
                        PAIR @get_coeff_compl ;
                        DIP 5 { DUP @apply_coeff } ;
                        DIG 5 ;
                        PAIR ;
                        DIP { DUP @s } ;
                        SWAP ;
                        { CDR ; CDR ; CDR ; CDR ; CAR %collat_coeff } ;
                        DIP 2 { DUP @s } ;
                        DIG 2 ;
                        { CDR ; CDR ; CDR ; CDR ; CDR ; CAR %deposited } ;
                        PAIR ;
                        PAIR ;
                        DUP ;
                        { CDR ; CAR @apply_coeff_slash_13 } ;
                        DIP { DUP } ;
                        SWAP ;
                        { CDR ; CDR @get_coeff_compl_slash_18 } ;
                        DIP 2 { DUP } ;
                        DIG 2 ;
                        CAR ;
                        CDR @collat_coeff ;
                        DIP { DUP ; CAR ; SWAP ; CDR } ;
                        PAIR ;
                        EXEC ;
                        DIP 2 { DUP } ;
                        DIG 2 ;
                        CAR ;
                        CAR @deposited ;
                        PAIR ;
                        DIP { DUP ; CAR ; SWAP ; CDR } ;
                        DIP 3 { DROP } ;
                        PAIR ;
                        EXEC ;
                        DIP { DUP @s } ;
                        SWAP ;
                        { CDR ; CDR ; CDR ; CDR ; CDR ; CDR ; CAR %borrowed } ;
                        DIP { DUP @max_borrowing } ;
                        SWAP ;
                        COMPARE ;
                        LT ;
                        IF { PUSH string "No available funds to borrow: contract is under-collateralized." ;
                             FAILWITH }
                           { UNIT } ;
                        DROP ;
                        DIP 2 { DUP @contract_balance } ;
                        DIG 2 ;
                        DIP 2 { DUP @s } ;
                        DIG 2 ;
                        { CDR ; CDR ; CDR ; CDR ; CDR ; CDR ; CAR %borrowed } ;
                        DIP 2 { DUP @max_borrowing } ;
                        DIG 2 ;
                        SUB ;
                        PAIR ;
                        DUP ;
                        CAR @a ;
                        DIP { DUP } ;
                        SWAP ;
                        CDR @b ;
                        DUP @b ;
                        DIP 2 { DUP @a } ;
                        DIG 2 ;
                        COMPARE ;
                        GT ;
                        IF { DUP @b } { DIP { DUP @a } ; SWAP } ;
                        DIP { DROP 3 } ;
                        PUSH mutez 0 ;
                        DIP { DUP @borrowing } ;
                        SWAP ;
                        COMPARE ;
                        EQ ;
                        IF { PUSH string "No available funds to borrow." ; FAILWITH } { UNIT } ;
                        DROP ;
                        DIP 2 { DUP @s } ;
                        DIG 2 ;
                        DUP ;
                        CAR %depositors ;
                        SWAP ;
                        CDR ;
                        DUP ;
                        CAR %owner ;
                        SWAP ;
                        CDR ;
                        DUP ;
                        CAR %min_deposit ;
                        SWAP ;
                        CDR ;
                        DUP ;
                        CAR %withdraw_fee ;
                        SWAP ;
                        CDR ;
                        DUP ;
                        CAR %collat_coeff ;
                        SWAP ;
                        CDR ;
                        DUP ;
                        CAR %deposited ;
                        SWAP ;
                        CDR ;
                        CDR ;
                        DIP 7 { DUP @borrowing } ;
                        DIG 7 ;
                        DIP 10 { DUP @s } ;
                        DIG 10 ;
                        { CDR ; CDR ; CDR ; CDR ; CDR ; CDR ; CAR %borrowed } ;
                        ADD ;
                        PAIR %borrowed ;
                        SWAP ;
                        PAIR %deposited ;
                        SWAP ;
                        PAIR %collat_coeff ;
                        SWAP ;
                        PAIR %withdraw_fee ;
                        SWAP ;
                        PAIR %min_deposit ;
                        SWAP ;
                        PAIR %owner ;
                        SWAP ;
                        PAIR @s %depositors ;
                        DUP @s ;
                        NIL operation ;
                        DIP 2 { DUP @s } ;
                        DIG 2 ;
                        { CDR ; CAR %owner } ;
                        CONTRACT unit ;
                        IF_NONE
                          { PUSH string "No entrypoint default with parameter type unit" ; FAILWITH }
                          {} ;
                        DIP 4 { DUP @borrowing } ;
                        DIG 4 ;
                        DIP 4 { DROP 3 } ;
                        UNIT ;
                        TRANSFER_TOKENS @op ;
                        CONS ;
                        PAIR }
                      { DUP @s ;
                        { CDR ; CAR %owner } ;
                        DIP 4 { DUP @sender } ;
                        DIG 4 ;
                        COMPARE ;
                        EQ ;
                        PUSH mutez 420000 ;
                        DIP 4 { DUP @amount } ;
                        DIG 4 ;
                        COMPARE ;
                        EQ ;
                        AND ;
                        IF { DUP @s ;
                             NIL operation ;
                             DIP 2 { DUP @s } ;
                             DIG 2 ;
                             { CDR ; CDR ; CDR ; CDR ; CDR ; CDR ; CDR ; CDR %delegate } ;
                             SOME ;
                             SET_DELEGATE @op_set_delegate ;
                             CONS ;
                             DIP 2 { DUP @s } ;
                             DIG 2 ;
                             { CDR ; CAR %owner } ;
                             CONTRACT unit ;
                             IF_NONE
                               { PUSH string "No entrypoint default with parameter type unit" ; FAILWITH }
                               {} ;
                             PUSH mutez 420000 ;
                             UNIT ;
                             TRANSFER_TOKENS @op_refund ;
                             CONS ;
                             PAIR }
                           { DUP @s ;
                             { CDR ; CAR %owner } ;
                             DIP 4 { DUP @sender } ;
                             DIG 4 ;
                             COMPARE ;
                             EQ ;
                             PUSH mutez 0 ;
                             DIP 4 { DUP @amount } ;
                             DIG 4 ;
                             COMPARE ;
                             GT ;
                             AND ;
                             IF { DUP @s ;
                                  { CDR ; CDR ; CDR ; CDR ; CDR ; CDR ; CAR @borrowed %borrowed } ;
                                  DIP 3 { DUP @amount } ;
                                  DIG 3 ;
                                  COMPARE ;
                                  GT ;
                                  IF { PUSH string "Can't over-collateralize contract." ; FAILWITH } { UNIT } ;
                                  DROP ;
                                  DUP @s ;
                                  DUP ;
                                  CAR %depositors ;
                                  SWAP ;
                                  CDR ;
                                  DUP ;
                                  CAR %owner ;
                                  SWAP ;
                                  CDR ;
                                  DUP ;
                                  CAR %min_deposit ;
                                  SWAP ;
                                  CDR ;
                                  DUP ;
                                  CAR %withdraw_fee ;
                                  SWAP ;
                                  CDR ;
                                  DUP ;
                                  CAR %collat_coeff ;
                                  SWAP ;
                                  CDR ;
                                  DUP ;
                                  CAR %deposited ;
                                  SWAP ;
                                  CDR ;
                                  CDR ;
                                  DIP 9 { DUP @amount } ;
                                  DIG 9 ;
                                  DIP 8 { DUP @s } ;
                                  DIG 8 ;
                                  { CDR ; CDR ; CDR ; CDR ; CDR ; CDR ; CAR %borrowed } ;
                                  SUB ;
                                  PAIR %borrowed ;
                                  SWAP ;
                                  PAIR %deposited ;
                                  SWAP ;
                                  PAIR %collat_coeff ;
                                  SWAP ;
                                  PAIR %withdraw_fee ;
                                  SWAP ;
                                  PAIR %min_deposit ;
                                  SWAP ;
                                  PAIR %owner ;
                                  SWAP ;
                                  PAIR @s %depositors ;
                                  NIL operation ;
                                  PAIR }
                                { PUSH string "You shouldn't be here." ; FAILWITH } } } } } ;
         DIP { DROP 7 } } }
