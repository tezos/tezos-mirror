# This file was automatically generated, do not edit.
# Edit file ci/bin/main.ml instead.

workflow:
  name: '[$PIPELINE_TYPE] $CI_COMMIT_TITLE'
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "merge_request_event"
      && $CI_MERGE_REQUEST_EVENT_TYPE != "merge_train"
    variables:
      PIPELINE_TYPE: before_merging
    when: always
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "merge_request_event"
      && $CI_MERGE_REQUEST_EVENT_TYPE == "merge_train"
    variables:
      PIPELINE_TYPE: merge_train
    when: always
    auto_cancel:
      on_job_failure: all
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH
      == "master"
    variables:
      PIPELINE_TYPE: master_branch
    when: always
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH
      == "latest-release"
    variables:
      PIPELINE_TYPE: octez_latest_release
    when: always
  - if: $CI_PROJECT_NAMESPACE != "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH
      == "latest-release-test"
    variables:
      PIPELINE_TYPE: octez_latest_release_test
    when: always
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG
      =~ /^octez-v\d+\.\d+(?:\-rc\d+)?$/
    variables:
      PIPELINE_TYPE: octez_release_tag
    when: always
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG
      =~ /^octez-v\d+\.\d+\-beta\d*$/
    variables:
      PIPELINE_TYPE: octez_beta_release_tag
    when: always
  - if: $CI_PROJECT_NAMESPACE != "tezos" && $CI_PIPELINE_SOURCE == "push" && ($CI_COMMIT_TAG
      =~ /^octez-v\d+\.\d+(?:\-rc\d+)?$/ || $CI_COMMIT_TAG =~ /^octez-v\d+\.\d+\-beta\d*$/)
    variables:
      PIPELINE_TYPE: octez_release_tag_test
    when: always
  - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG =~ /^octez-evm-node-v\d+\.\d+(?:\-rc\d+)?$/
    variables:
      PIPELINE_TYPE: octez_evm_node_release_tag
    when: always
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG
      != null && $CI_COMMIT_TAG !~ /^octez-v\d+\.\d+(?:\-rc\d+)?$/ && $CI_COMMIT_TAG
      !~ /^octez-v\d+\.\d+\-beta\d*$/ && $CI_COMMIT_TAG !~ /^octez-evm-node-v\d+\.\d+(?:\-rc\d+)?$/
    variables:
      PIPELINE_TYPE: non_release_tag
    when: always
  - if: $CI_PROJECT_NAMESPACE != "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG
      != null && $CI_COMMIT_TAG !~ /^octez-v\d+\.\d+(?:\-rc\d+)?$/ && $CI_COMMIT_TAG
      !~ /^octez-v\d+\.\d+\-beta\d*$/ && $CI_COMMIT_TAG !~ /^octez-evm-node-v\d+\.\d+(?:\-rc\d+)?$/
    variables:
      PIPELINE_TYPE: non_release_tag_test
    when: always
  - if: $CI_PIPELINE_SOURCE == "schedule" && $TZ_SCHEDULE_KIND == "EXTENDED_TESTS"
    variables:
      PIPELINE_TYPE: schedule_extended_test
    when: always
  - if: $CI_PIPELINE_SOURCE == "schedule" && $TZ_SCHEDULE_KIND == "EXTENDED_RPC_TESTS"
    variables:
      PIPELINE_TYPE: schedule_extended_rpc_test
    when: always
  - if: $CI_PIPELINE_SOURCE == "schedule" && $TZ_SCHEDULE_KIND == "EXTENDED_VALIDATION_TESTS"
    variables:
      PIPELINE_TYPE: schedule_extended_validation_test
    when: always

default:
  interruptible: true

variables:
  ci_image_name: ${GCP_REGISTRY}/${CI_PROJECT_PATH}/ci
  rust_toolchain_image_name: ${GCP_REGISTRY}/${CI_PROJECT_PATH}/rust-toolchain
  jsonnet_image_name: ${GCP_REGISTRY}/${CI_PROJECT_PATH}/jsonnet
  client_libs_dependencies_image_name: ${GCP_REGISTRY}/${CI_PROJECT_PATH}/client-libs-dependencies
  GIT_STRATEGY: fetch
  GIT_DEPTH: "1"
  GET_SOURCES_ATTEMPTS: "2"
  ARTIFACT_DOWNLOAD_ATTEMPTS: "2"
  OPAMRETRIES: "5"
  FF_USE_FASTZIP: "true"
  RUNTEZTALIAS: "false"
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  CARGO_NET_OFFLINE: "true"
  CARGO_TERM_QUIET: "true"

dummy_job:
  stage: .pre
  rules:
  - if: $foo == "bar" && $foo != "bar"
    when: on_success
  script:
  - echo "This job will never execute"

include:
- local: .gitlab/ci/pipelines/before_merging.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "merge_request_event"
      && $CI_MERGE_REQUEST_EVENT_TYPE != "merge_train"
    when: always
- local: .gitlab/ci/pipelines/merge_train.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "merge_request_event"
      && $CI_MERGE_REQUEST_EVENT_TYPE == "merge_train"
    when: always
- local: .gitlab/ci/pipelines/master_branch.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH
      == "master"
    when: always
- local: .gitlab/ci/pipelines/octez_latest_release.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH
      == "latest-release"
    when: always
- local: .gitlab/ci/pipelines/octez_latest_release_test.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE != "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH
      == "latest-release-test"
    when: always
- local: .gitlab/ci/pipelines/octez_release_tag.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG
      =~ /^octez-v\d+\.\d+(?:\-rc\d+)?$/
    when: always
- local: .gitlab/ci/pipelines/octez_beta_release_tag.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG
      =~ /^octez-v\d+\.\d+\-beta\d*$/
    when: always
- local: .gitlab/ci/pipelines/octez_release_tag_test.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE != "tezos" && $CI_PIPELINE_SOURCE == "push" && ($CI_COMMIT_TAG
      =~ /^octez-v\d+\.\d+(?:\-rc\d+)?$/ || $CI_COMMIT_TAG =~ /^octez-v\d+\.\d+\-beta\d*$/)
    when: always
- local: .gitlab/ci/pipelines/octez_evm_node_release_tag.yml
  rules:
  - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG =~ /^octez-evm-node-v\d+\.\d+(?:\-rc\d+)?$/
    when: always
- local: .gitlab/ci/pipelines/non_release_tag.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG
      != null && $CI_COMMIT_TAG !~ /^octez-v\d+\.\d+(?:\-rc\d+)?$/ && $CI_COMMIT_TAG
      !~ /^octez-v\d+\.\d+\-beta\d*$/ && $CI_COMMIT_TAG !~ /^octez-evm-node-v\d+\.\d+(?:\-rc\d+)?$/
    when: always
- local: .gitlab/ci/pipelines/non_release_tag_test.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE != "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG
      != null && $CI_COMMIT_TAG !~ /^octez-v\d+\.\d+(?:\-rc\d+)?$/ && $CI_COMMIT_TAG
      !~ /^octez-v\d+\.\d+\-beta\d*$/ && $CI_COMMIT_TAG !~ /^octez-evm-node-v\d+\.\d+(?:\-rc\d+)?$/
    when: always
- local: .gitlab/ci/pipelines/schedule_extended_test.yml
  rules:
  - if: $CI_PIPELINE_SOURCE == "schedule" && $TZ_SCHEDULE_KIND == "EXTENDED_TESTS"
    when: always
- local: .gitlab/ci/pipelines/schedule_extended_rpc_test.yml
  rules:
  - if: $CI_PIPELINE_SOURCE == "schedule" && $TZ_SCHEDULE_KIND == "EXTENDED_RPC_TESTS"
    when: always
- local: .gitlab/ci/pipelines/schedule_extended_validation_test.yml
  rules:
  - if: $CI_PIPELINE_SOURCE == "schedule" && $TZ_SCHEDULE_KIND == "EXTENDED_VALIDATION_TESTS"
    when: always
